-- *********************************************************************
-- Update Database Script
-- *********************************************************************
-- Change Log: db/changelog/db.changelog-master.yaml
-- Ran at: 25. 11. 25. 오전 6:59
-- Against: null@offline:oracle
-- Liquibase version: 4.25.1
-- *********************************************************************

-- Changeset db/changelog/changes/001-create-users-table.yaml::1::developer
-- Create users table
CREATE TABLE CLIENT.users (id NUMBER(38, 0) GENERATED BY DEFAULT AS IDENTITY NOT NULL, name VARCHAR2(100) NOT NULL, email VARCHAR2(255) NOT NULL, CONSTRAINT PK_USERS PRIMARY KEY (id), UNIQUE (email));

-- Changeset db/changelog/changes/001-create-users-table.yaml::2::developer
-- Insert initial users
INSERT INTO CLIENT.users (name, email) VALUES ('John Doe', 'john@example.com');

INSERT INTO CLIENT.users (name, email) VALUES ('Jane Smith', 'jane@example.com');

-- Changeset db/changelog/changes/002-add-phone-column.yaml::3::developer
-- Add phone column to users table
ALTER TABLE CLIENT.users ADD phone VARCHAR2(20);

-- Changeset db/changelog/changes/002-add-phone-column.yaml::4::developer
-- Update existing users with phone numbers
UPDATE CLIENT.users SET phone = '010-1234-5678' WHERE email='john@example.com';

UPDATE CLIENT.users SET phone = '010-8765-4321' WHERE email='jane@example.com';

-- Changeset db/changelog/changes/003-create-orders-table.yaml::5::developer
-- Create orders table
CREATE TABLE CLIENT.orders (id NUMBER(38, 0) GENERATED BY DEFAULT AS IDENTITY NOT NULL, user_id NUMBER(38, 0) NOT NULL, product_name VARCHAR2(255) NOT NULL, quantity INTEGER DEFAULT 1 NOT NULL, total_price DECIMAL(10, 2) NOT NULL, created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, CONSTRAINT PK_ORDERS PRIMARY KEY (id), CONSTRAINT fk_orders_user FOREIGN KEY (user_id) REFERENCES CLIENT.users(id));

-- Changeset db/changelog/changes/003-create-orders-table.yaml::6::developer
-- Insert sample orders
INSERT INTO CLIENT.orders (user_id, product_name, quantity, total_price) VALUES (1, 'Laptop', 1, 1500000.0);

INSERT INTO CLIENT.orders (user_id, product_name, quantity, total_price) VALUES (1, 'Mouse', 2, 50000.0);

INSERT INTO CLIENT.orders (user_id, product_name, quantity, total_price) VALUES (2, 'Keyboard', 1, 150000.0);

-- Changeset db/changelog/changes/004-migrate-users-to-members.yaml::7::developer
-- Tag before migration for rollback point
-- Changeset db/changelog/changes/004-migrate-users-to-members.yaml::8::developer
-- Create new members table with improved structure
CREATE TABLE CLIENT.members (id NUMBER(38, 0) GENERATED BY DEFAULT AS IDENTITY NOT NULL, first_name VARCHAR2(50) NOT NULL, last_name VARCHAR2(50) NOT NULL, email VARCHAR2(255) NOT NULL, phone_country_code VARCHAR2(5), phone_number VARCHAR2(15), status VARCHAR2(20) DEFAULT 'ACTIVE', created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, CONSTRAINT PK_MEMBERS PRIMARY KEY (id), UNIQUE (email));

-- Changeset db/changelog/changes/004-migrate-users-to-members.yaml::9::developer
-- Migrate data from users to members table (Oracle)
INSERT INTO members (id, first_name, last_name, email, phone_country_code, phone_number, status)
SELECT
  id,
  SUBSTR(name, 1, INSTR(name || ' ', ' ') - 1) as first_name,
  CASE
    WHEN INSTR(name, ' ') > 0 THEN SUBSTR(name, INSTR(name, ' ') + 1)
    ELSE ''
  END as last_name,
  email,
  CASE
    WHEN phone IS NOT NULL THEN SUBSTR(phone, 1, 3)
    ELSE NULL
  END as phone_country_code,
  CASE
    WHEN phone IS NOT NULL THEN REPLACE(SUBSTR(phone, 5), '-', '')
    ELSE NULL
  END as phone_number,
  'ACTIVE' as status
FROM users;

-- Changeset db/changelog/changes/004-migrate-users-to-members.yaml::10::developer
-- Update orders foreign key to reference members
ALTER TABLE CLIENT.orders DROP CONSTRAINT FK_ORDERS_USER;

ALTER TABLE CLIENT.orders ADD CONSTRAINT FK_ORDERS_MEMBER FOREIGN KEY (user_id) REFERENCES CLIENT.members (id);

-- Changeset db/changelog/changes/004-migrate-users-to-members.yaml::11::developer
-- Backup and drop old users table
CREATE TABLE CLIENT.users_backup (id NUMBER(38, 0), name VARCHAR2(100), email VARCHAR2(255), phone VARCHAR2(20), backed_up_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP);

INSERT INTO users_backup (id, name, email, phone) SELECT id, name, email, phone FROM users;

DROP TABLE CLIENT.users;

-- Changeset db/changelog/changes/004-migrate-users-to-members.yaml::12::developer
-- Tag after successful migration
