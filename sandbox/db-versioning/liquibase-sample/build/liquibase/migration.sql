-- Create Database Lock Table
CREATE TABLE PUBLIC.DATABASECHANGELOGLOCK (ID INT NOT NULL, LOCKED BOOLEAN NOT NULL, LOCKGRANTED TIMESTAMP, LOCKEDBY VARCHAR(255), CONSTRAINT PK_DATABASECHANGELOGLOCK PRIMARY KEY (ID));

-- Initialize Database Lock Table
DELETE FROM PUBLIC.DATABASECHANGELOGLOCK;

INSERT INTO PUBLIC.DATABASECHANGELOGLOCK (ID, LOCKED) VALUES (1, FALSE);

-- Lock Database
UPDATE PUBLIC.DATABASECHANGELOGLOCK SET LOCKED = TRUE, LOCKEDBY = 'ljsui-MacBookAir.local (192.168.0.27)', LOCKGRANTED = NOW() WHERE ID = 1 AND LOCKED = FALSE;

-- Create Database Change Log Table
CREATE TABLE PUBLIC.DATABASECHANGELOG (ID VARCHAR(255) NOT NULL, AUTHOR VARCHAR(255) NOT NULL, FILENAME VARCHAR(255) NOT NULL, DATEEXECUTED TIMESTAMP NOT NULL, ORDEREXECUTED INT NOT NULL, EXECTYPE VARCHAR(10) NOT NULL, MD5SUM VARCHAR(35), DESCRIPTION VARCHAR(255), COMMENTS VARCHAR(255), TAG VARCHAR(255), LIQUIBASE VARCHAR(20), CONTEXTS VARCHAR(255), LABELS VARCHAR(255), DEPLOYMENT_ID VARCHAR(10));

-- *********************************************************************
-- Update Database Script
-- *********************************************************************
-- Change Log: db/changelog/db.changelog-master.yaml
-- Ran at: 25. 11. 25. 오전 6:55
-- Against: SA@jdbc:h2:mem:liquibasedb
-- Liquibase version: 4.25.1
-- *********************************************************************

-- Changeset db/changelog/changes/001-create-users-table.yaml::1::developer
-- Create users table
CREATE TABLE PUBLIC.users (id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL, name VARCHAR(100) NOT NULL, email VARCHAR(255) NOT NULL, CONSTRAINT PK_USERS PRIMARY KEY (id), UNIQUE (email));

INSERT INTO PUBLIC.DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS, EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID) VALUES ('1', 'developer', 'db/changelog/changes/001-create-users-table.yaml', NOW(), 1, '9:2f4cff8c68e4bda903f4ba079e846dc0', 'createTable tableName=users', 'Create users table', 'EXECUTED', NULL, NULL, '4.25.1', '4021304348');

-- Changeset db/changelog/changes/001-create-users-table.yaml::2::developer
-- Insert initial users
INSERT INTO PUBLIC.users (name, email) VALUES ('John Doe', 'john@example.com');

INSERT INTO PUBLIC.users (name, email) VALUES ('Jane Smith', 'jane@example.com');

INSERT INTO PUBLIC.DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS, EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID) VALUES ('2', 'developer', 'db/changelog/changes/001-create-users-table.yaml', NOW(), 2, '9:6b416c265f0dbef4b1e17cc9ccec3b7f', 'insert tableName=users; insert tableName=users', 'Insert initial users', 'EXECUTED', NULL, NULL, '4.25.1', '4021304348');

-- Changeset db/changelog/changes/002-add-phone-column.yaml::3::developer
-- Add phone column to users table
ALTER TABLE PUBLIC.users ADD phone VARCHAR(20);

INSERT INTO PUBLIC.DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS, EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID) VALUES ('3', 'developer', 'db/changelog/changes/002-add-phone-column.yaml', NOW(), 3, '9:a260b7827b4629bbf89f7b39fe8273ce', 'addColumn tableName=users', 'Add phone column to users table', 'EXECUTED', NULL, NULL, '4.25.1', '4021304348');

-- Changeset db/changelog/changes/002-add-phone-column.yaml::4::developer
-- Update existing users with phone numbers
UPDATE PUBLIC.users SET phone = '010-1234-5678' WHERE email='john@example.com';

UPDATE PUBLIC.users SET phone = '010-8765-4321' WHERE email='jane@example.com';

INSERT INTO PUBLIC.DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS, EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID) VALUES ('4', 'developer', 'db/changelog/changes/002-add-phone-column.yaml', NOW(), 4, '9:16333a405cac3ebde147a513c02ee890', 'update tableName=users; update tableName=users', 'Update existing users with phone numbers', 'EXECUTED', NULL, NULL, '4.25.1', '4021304348');

-- Changeset db/changelog/changes/003-create-orders-table.yaml::5::developer
-- Create orders table
CREATE TABLE PUBLIC.orders (id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL, user_id BIGINT NOT NULL, product_name VARCHAR(255) NOT NULL, quantity INT DEFAULT 1 NOT NULL, total_price DECIMAL(10, 2) NOT NULL, created_at TIMESTAMP DEFAULT NOW(), CONSTRAINT PK_ORDERS PRIMARY KEY (id), CONSTRAINT fk_orders_user FOREIGN KEY (user_id) REFERENCES PUBLIC.users(id));

INSERT INTO PUBLIC.DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS, EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID) VALUES ('5', 'developer', 'db/changelog/changes/003-create-orders-table.yaml', NOW(), 5, '9:6a55b2b100d17f22b4814749d664a992', 'createTable tableName=orders', 'Create orders table', 'EXECUTED', NULL, NULL, '4.25.1', '4021304348');

-- Changeset db/changelog/changes/003-create-orders-table.yaml::6::developer
-- Insert sample orders
INSERT INTO PUBLIC.orders (user_id, product_name, quantity, total_price) VALUES (1, 'Laptop', 1, 1500000.0);

INSERT INTO PUBLIC.orders (user_id, product_name, quantity, total_price) VALUES (1, 'Mouse', 2, 50000.0);

INSERT INTO PUBLIC.orders (user_id, product_name, quantity, total_price) VALUES (2, 'Keyboard', 1, 150000.0);

INSERT INTO PUBLIC.DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS, EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID) VALUES ('6', 'developer', 'db/changelog/changes/003-create-orders-table.yaml', NOW(), 6, '9:bc81603d9e5a08bbd52d9e2fa5ce5b37', 'insert tableName=orders; insert tableName=orders; insert tableName=orders', 'Insert sample orders', 'EXECUTED', NULL, NULL, '4.25.1', '4021304348');

-- Changeset db/changelog/changes/004-migrate-users-to-members.yaml::7::developer
-- Tag before migration for rollback point
INSERT INTO PUBLIC.DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS, EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID, TAG) VALUES ('7', 'developer', 'db/changelog/changes/004-migrate-users-to-members.yaml', NOW(), 7, '9:5298756285f6e1c5ee799924d4c980e4', 'tagDatabase', 'Tag before migration for rollback point', 'EXECUTED', NULL, NULL, '4.25.1', '4021304348', 'before-users-migration');

-- Changeset db/changelog/changes/004-migrate-users-to-members.yaml::8::developer
-- Create new members table with improved structure
CREATE TABLE PUBLIC.members (id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL, first_name VARCHAR(50) NOT NULL, last_name VARCHAR(50) NOT NULL, email VARCHAR(255) NOT NULL, phone_country_code VARCHAR(5), phone_number VARCHAR(15), status VARCHAR(20) DEFAULT 'ACTIVE', created_at TIMESTAMP DEFAULT NOW(), updated_at TIMESTAMP DEFAULT NOW(), CONSTRAINT PK_MEMBERS PRIMARY KEY (id), UNIQUE (email));

INSERT INTO PUBLIC.DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS, EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID) VALUES ('8', 'developer', 'db/changelog/changes/004-migrate-users-to-members.yaml', NOW(), 8, '9:96c3bc4e11ab61780e8a0785ce7482c0', 'createTable tableName=members', 'Create new members table with improved structure', 'EXECUTED', NULL, NULL, '4.25.1', '4021304348');

-- Changeset db/changelog/changes/004-migrate-users-to-members.yaml::9::developer
-- Migrate data from users to members table
INSERT INTO members (id, first_name, last_name, email, phone_country_code, phone_number, status)
SELECT
  id,
  SUBSTRING(name, 1, LOCATE(' ', name || ' ') - 1) as first_name,
  CASE
    WHEN LOCATE(' ', name) > 0 THEN SUBSTRING(name, LOCATE(' ', name) + 1)
    ELSE ''
  END as last_name,
  email,
  CASE
    WHEN phone IS NOT NULL THEN SUBSTRING(phone, 1, 3)
    ELSE NULL
  END as phone_country_code,
  CASE
    WHEN phone IS NOT NULL THEN REPLACE(SUBSTRING(phone, 5), '-', '')
    ELSE NULL
  END as phone_number,
  'ACTIVE' as status
FROM users;

INSERT INTO PUBLIC.DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS, EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID) VALUES ('9', 'developer', 'db/changelog/changes/004-migrate-users-to-members.yaml', NOW(), 9, '9:e9e12a8b59884b4a8f58ed891288b182', 'sql', 'Migrate data from users to members table', 'EXECUTED', NULL, NULL, '4.25.1', '4021304348');

-- Changeset db/changelog/changes/004-migrate-users-to-members.yaml::10::developer
-- Update orders foreign key to reference members
ALTER TABLE PUBLIC.orders DROP CONSTRAINT FK_ORDERS_USER;

ALTER TABLE PUBLIC.orders ADD CONSTRAINT FK_ORDERS_MEMBER FOREIGN KEY (user_id) REFERENCES PUBLIC.members (id);

INSERT INTO PUBLIC.DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS, EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID) VALUES ('10', 'developer', 'db/changelog/changes/004-migrate-users-to-members.yaml', NOW(), 10, '9:52c620688a59280163bfd5ff7feb8903', 'dropForeignKeyConstraint baseTableName=orders, constraintName=FK_ORDERS_USER; addForeignKeyConstraint baseTableName=orders, constraintName=FK_ORDERS_MEMBER, referencedTableName=members', 'Update orders foreign key to reference members', 'EXECUTED', NULL, NULL, '4.25.1', '4021304348');

-- Changeset db/changelog/changes/004-migrate-users-to-members.yaml::11::developer
-- Backup and drop old users table
CREATE TABLE PUBLIC.users_backup (id BIGINT, name VARCHAR(100), email VARCHAR(255), phone VARCHAR(20), backed_up_at TIMESTAMP DEFAULT NOW());

INSERT INTO users_backup (id, name, email, phone) SELECT id, name, email, phone FROM users;

DROP TABLE PUBLIC.users;

INSERT INTO PUBLIC.DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS, EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID) VALUES ('11', 'developer', 'db/changelog/changes/004-migrate-users-to-members.yaml', NOW(), 11, '9:331b6628b967ab05b5733598a9d5b80a', 'createTable tableName=users_backup; sql; dropTable tableName=users', 'Backup and drop old users table', 'EXECUTED', NULL, NULL, '4.25.1', '4021304348');

-- Changeset db/changelog/changes/004-migrate-users-to-members.yaml::12::developer
-- Tag after successful migration
INSERT INTO PUBLIC.DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS, EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID, TAG) VALUES ('12', 'developer', 'db/changelog/changes/004-migrate-users-to-members.yaml', NOW(), 12, '9:b98a288262f91f528360472c34254792', 'tagDatabase', 'Tag after successful migration', 'EXECUTED', NULL, NULL, '4.25.1', '4021304348', 'after-users-migration');

-- Release Database Lock
UPDATE PUBLIC.DATABASECHANGELOGLOCK SET LOCKED = FALSE, LOCKEDBY = NULL, LOCKGRANTED = NULL WHERE ID = 1;

